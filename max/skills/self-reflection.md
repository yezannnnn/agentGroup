# 自我反省 Skill (Self-Reflection)

**作者**: 麦克斯 (Max) - 项目经理
**版本**: v1.0
**创建日期**: 2026-02-19
**目的**: 从错误中学习，持续自我升级，防止同类错误再次发生

---

## 1. Skill 目的

自我反省系统让 Max 能够：
- 在会话中检测自身错误（Token估算偏差、授权违规、逻辑错误等）
- 对错误进行结构化根因分析
- 生成可执行的改进措施
- 将学习成果持久化到 CLAUDE.md 和记忆文件
- 建立错误模式库，预防同类错误

---

## 2. 触发机制

### 2.1 自动触发条件

```
TRIGGER self-reflection WHEN:
1. Token估算偏差 > 50%
   - 公式: |实际tokens - 预估tokens| / 预估tokens > 0.5
   - 检测时机: 任务完成后对比预估与实际

2. 授权规则违规
   - 使用Opus未获用户授权
   - 执行git commit/push未获授权
   - 超出职责边界操作

3. 用户负面反馈
   - 用户明确指出错误
   - 用户要求重做
   - 用户表达不满

4. 流程检查点跳过
   - 任何强制检查点被遗漏
   - 检查点顺序错误

5. 输出质量问题
   - 过度设计（交付远超需求）
   - 欠设计（交付不满足需求）
   - 格式/结构问题
```

### 2.2 手动触发

```
命令: /reflect
参数:
  - /reflect [错误描述]     # 对指定错误进行反思
  - /reflect --review       # 回顾近期错误模式
  - /reflect --stats        # 显示错误统计
  - /reflect --update-rules # 根据学习成果更新规则
```

### 2.3 定期触发

```
每10次对话自动触发一次错误模式回顾:
- 检查 ./memory/reflection-log.json 中的错误记录
- 分析是否存在重复模式
- 更新检测规则和阈值
```

---

## 3. 错误分类体系

### 3.1 一级分类

| 类别代码 | 名称 | 严重度 | 描述 |
|----------|------|--------|------|
| E-TOKEN | Token估算错误 | 高 | 预估与实际消耗偏差>50% |
| E-AUTH | 授权违规 | 严重 | 未获授权执行受限操作 |
| E-SCOPE | 范围越界 | 高 | 交付超出或不满足需求 |
| E-FLOW | 流程违规 | 中 | 跳过必要检查点或流程 |
| E-LOGIC | 逻辑错误 | 中 | 分析推理错误 |
| E-TOOL | 工具使用错误 | 低 | 错误选择或使用工具 |

### 3.2 二级分类（Token估算错误细分）

| 子类代码 | 名称 | 检测规则 |
|----------|------|----------|
| E-TOKEN-LOW | 低估 | 实际 > 预估 * 1.5 |
| E-TOKEN-HIGH | 高估 | 实际 < 预估 * 0.5 |
| E-TOKEN-MISS | 未估算 | 跳过估算步骤 |

### 3.3 二级分类（授权违规细分）

| 子类代码 | 名称 | 检测规则 |
|----------|------|----------|
| E-AUTH-OPUS | Opus未授权 | 使用Opus前未获用户确认 |
| E-AUTH-GIT | Git未授权 | commit/push未获用户确认 |
| E-AUTH-BOUNDARY | 职责越界 | 执行他人职责范围内操作 |

---

## 4. 自动反思流程

### 4.1 错误检测阶段

```
STEP 1: 识别错误
- 对比预估与实际token消耗
- 检查是否有授权违规
- 回顾用户反馈信号
- 检查流程完整性

OUTPUT: 错误清单（类型、严重度、上下文）
```

### 4.2 根因分析阶段（5W1H）

```
STEP 2: 对每个错误执行5W1H分析

What（什么错误）: 具体描述发生了什么
Why（为什么发生）: 根本原因是什么
When（何时发生）: 在哪个检查点/步骤发生
Where（哪里出错）: 涉及哪些文件/工具/流程
Who（谁受影响）: 对用户/团队的影响
How（如何修复）: 具体的改进措施

OUTPUT: 结构化根因分析报告
```

### 4.3 改进方案生成阶段

```
STEP 3: 生成改进方案

对每个根因生成:
1. 即时修复 - 当前会话中可以做什么
2. 规则更新 - CLAUDE.md需要添加/修改什么规则
3. 检测增强 - 如何更早发现类似错误
4. 预防措施 - 如何防止再次发生

OUTPUT: 可执行的改进行动清单
```

### 4.4 持久化阶段

```
STEP 4: 记录和更新

1. 写入错误日志: ./memory/reflection-log.json
2. 更新错误模式库: ./skills/reflection-patterns.json
3. 更新CLAUDE.md: 添加新规则/检查点
4. 更新MEMORY.md: 记录关键教训

OUTPUT: 确认所有更新完成
```

---

## 5. CLAUDE.md 更新策略

### 5.1 更新原则

- **只添加不删除** - 新规则追加到现有规则之后
- **具体化优先** - 新规则必须包含可检测的具体条件
- **最小化改动** - 只更新与错误直接相关的部分
- **版本记录** - 每次更新附带日期和原因

### 5.2 更新位置映射

| 错误类型 | 更新位置 |
|----------|----------|
| E-TOKEN | 第0检查点 - 增加估算精度规则 |
| E-AUTH | 违规检测标准 - 增加新的检测条件 |
| E-SCOPE | 第0检查点 - 增加范围确认规则 |
| E-FLOW | 强制检查点序列 - 增加缺失步骤 |
| E-LOGIC | 自我监控协议 - 增加逻辑检查 |
| E-TOOL | 执行路径选择 - 更新工具选择指南 |

### 5.3 更新格式

```markdown
### 学习记录 - [YYYY-MM-DD]
**错误**: [错误代码] [简述]
**根因**: [根本原因]
**新规则**: [新增的规则内容]
**预防**: [预防措施]
```

---

## 6. Token估算校准系统

### 6.1 估算基准表

基于历史数据建立的Token消耗基准：

| 任务类型 | 预估范围 | 校准系数 |
|----------|----------|----------|
| 读取单文件 | 200-500 | 1.0x |
| 简单问答 | 300-800 | 1.0x |
| 文件创建（小） | 800-2000 | 1.3x |
| 文件创建（中） | 2000-5000 | 1.5x |
| 多文件操作 | 3000-8000 | 1.8x |
| 系统设计 | 5000-15000 | 2.0x |
| 复杂分析+实施 | 8000-20000 | 2.0x |

### 6.2 校准规则

```
Token估算校准流程:
1. 初始估算 = 基准表查询
2. 校准估算 = 初始估算 * 校准系数
3. 上报估算 = ceil(校准估算 / 1000) * 1000  # 向上取整到千
4. 如果上报估算 > 5000，必须向用户报告并确认

校准系数更新:
- 每次任务完成后: 新系数 = 0.7 * 旧系数 + 0.3 * (实际/预估)
- 系数范围限制: [0.5, 3.0]
```

### 6.3 常见低估场景（必须额外注意）

```
以下场景容易低估，必须乘以额外系数:
- 创建新的完整系统（3个以上文件）: x2.5
- 涉及JSON结构设计: x1.5
- 涉及脚本编写: x1.8
- 需要读取多个现有文件做上下文: x1.5
- 用户需求描述详细且要求完整实现: x2.0
```

---

## 7. 授权管理增强

### 7.1 授权检查清单

在执行任何操作前，按此清单检查：

```
[ ] 此操作是否需要用户授权？
    - Opus模型使用 -> 需要
    - git commit/push -> 需要
    - 修改CLAUDE.md核心规则 -> 需要
    - 超出PM职责的操作 -> 需要

[ ] 此操作是否在永久授权范围内？
    - 更新status.json -> 已授权
    - 更新todos.md -> 已授权
    - 记录Bug -> 已授权
    - 更新会议记录 -> 已授权

[ ] 如果需要授权，是否已获得？
    - 查看对话历史中用户是否明确授权
    - "可以"/"好的"/"同意" 等肯定回复 = 已授权
    - 沉默/无回复 != 已授权
```

### 7.2 授权违规预防

```
在执行以下操作前，必须插入授权确认步骤:

1. 模型升级确认:
   输出: "此任务建议使用 [Opus] 模型，预估额外成本 $X.XX，是否授权？"
   等待: 用户明确回复

2. Git操作确认:
   输出: "已准备好提交，等待您的授权"
   等待: 用户明确回复

3. 高成本操作确认:
   输出: "此任务预估消耗 [X] tokens（$X.XX），是否继续？"
   等待: 用户明确回复（当预估 > 5000 tokens时触发）
```

---

## 8. 反思报告模板

### 8.1 单次反思报告

```markdown
# 自我反思报告 - [日期时间]

## 错误概述
- **错误代码**: [E-XXX-XXX]
- **严重度**: [严重/高/中/低]
- **影响**: [对用户/项目的具体影响]

## 5W1H 分析
- **What**: [发生了什么]
- **Why**: [为什么发生]
- **When**: [何时发生]
- **Where**: [哪里出错]
- **Who**: [谁受影响]
- **How**: [如何修复]

## 根本原因
[深层原因分析]

## 改进措施
1. **即时修复**: [当前可做的]
2. **规则更新**: [需要更新的规则]
3. **检测增强**: [需要增加的检测]
4. **预防措施**: [长期预防方案]

## CLAUDE.md 更新
[具体需要添加/修改的内容]

## 验证方法
[如何验证改进有效]
```

### 8.2 定期回顾报告

```markdown
# 错误模式回顾 - [日期]

## 统计摘要
- 总错误数: X
- 按类型分布: TOKEN(X) AUTH(X) SCOPE(X) FLOW(X) LOGIC(X) TOOL(X)
- 重复模式: [识别到的重复错误]
- 改进趋势: [是否在减少]

## 高频错误 TOP 3
1. [错误模式1] - 出现X次 - 当前状态
2. [错误模式2] - 出现X次 - 当前状态
3. [错误模式3] - 出现X次 - 当前状态

## 规则有效性评估
- 有效规则: [列表]
- 需要调整的规则: [列表]
- 需要新增的规则: [列表]

## 下一步行动
[具体改进行动]
```

---

## 9. 使用方法

### 9.1 会话内反思

当检测到错误或用户指出错误时：

```
1. 立即停止当前任务
2. 输出: "🔍 检测到错误，启动自我反思..."
3. 执行4阶段反思流程
4. 输出反思报告
5. 询问用户是否需要更新CLAUDE.md
6. 记录到 ./memory/reflection-log.json
7. 继续原任务（如适用）
```

### 9.2 会话间学习

```
每次新会话启动时:
1. 读取 ./memory/reflection-log.json
2. 检查是否有未处理的改进措施
3. 验证最近的错误是否已预防
4. 更新错误模式统计
```

### 9.3 与其他Skill的集成

```
- token-optimization.md: 反思结果用于更新Token估算基准
- CLAUDE.md 检查点: 反思结果用于增加新检查点
- MEMORY.md: 关键教训记录到全局记忆
```

---

## 10. 持续改进循环

```
┌─────────────────────────────────────────┐
│         持续改进循环 (PDCA)              │
│                                         │
│  Plan: 基于错误模式制定改进计划          │
│    ↓                                    │
│  Do: 更新规则、检查点、检测逻辑          │
│    ↓                                    │
│  Check: 在后续会话中验证改进效果         │
│    ↓                                    │
│  Act: 根据验证结果调整和固化             │
│    ↓                                    │
│  (循环回到 Plan)                        │
│                                         │
└─────────────────────────────────────────┘

触发频率:
- 实时: 每次错误发生时立即反思
- 定期: 每10次对话进行一次模式回顾
- 月度: 月末进行一次全面评估
```
